/**
 * @file Firestore Security Rules
 * @core-philosophy This ruleset enforces a strict user-ownership model and an activation system.
 * @data-structure
 *   - Data is organized hierarchically under `/users/{userId}`.
 *   - Access to user-nested data requires the user account to be activated.
 *   - Activation codes are stored in a root collection `/activationCodes`.
 * @key-security-decisions
 *   - Only a specific admin user can create and manage activation codes.
 *   - Authenticated users can redeem an unused activation code.
 *   - Activated users can perform CRUD operations on their own data (`clients`, `vehicles`, etc.).
 *   - Unactivated users are denied access to all data except their own user profile and the activation code they are trying to read.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function isAdmin() {
      return request.auth.uid == 'wtMBWT7OAoXHj9Hlb6alnfFqK3Q2';
    }

    function isActivated(userId) {
      // Admin is always considered activated.
      // For others, check if the user's `isActivated` field is true and not expired.
      return isAdmin() || (
        get(/databases/$(database)/documents/users/$(userId)).data.isActivated == true &&
        get(/databases/$(database)/documents/users/$(userId)).data.activatedUntil > request.time
      );
    }

    /**
     * @description Controls access to user profile information.
     * @allow (create) - Any signed-in user can create their own profile.
     * @allow (get, update) - A user can read or update their own profile.
     * @deny (list, delete) - Listing or deleting user profiles is disallowed.
     */
    match /users/{userId} {
      allow get, update: if isSignedIn() && isOwner(userId);
      allow list, delete: if false;
      allow create: if isSignedIn() && isOwner(userId);
    }
    
    /**
     * @description Controls access to activation codes.
     * @allow (create) - Only the admin can create codes.
     * @allow (list) - Only the admin can list codes.
     * @allow (get) - Any authenticated user can read a single code (to check its status).
     * @allow (update) - Only an authenticated user can redeem an unused code.
     * @deny (delete) - Deleting codes is disallowed for safety.
     */
    match /activationCodes/{codeId} {
      allow get: if isSignedIn();
      allow list: if isAdmin();
      allow create: if isAdmin();
      // Allow update only if the code is being marked as used, is not already used,
      // and the user is the one using it.
      allow update: if isSignedIn() 
                    && request.resource.data.isUsed == true
                    && resource.data.isUsed == false
                    && request.resource.data.usedBy == request.auth.uid;
      allow delete: if false;
    }

    /**
     * @description Controls access to client information for a specific user.
     * @allow (all) - Only an activated user can perform CRUD on their own clients.
     * @deny (all) - Unactivated users or users trying to access other's data are denied.
     */
    match /users/{userId}/clients/{clientId} {
      allow read, write: if isSignedIn() && isOwner(userId) && isActivated(userId);
    }

    /**
     * @description Controls access to vehicle information for a specific client.
     * @allow (all) - Only an activated user can perform CRUD on their own vehicles.
     * @deny (all) - Unactivated users or users trying to access other's data are denied.
     */
    match /users/{userId}/clients/{clientId}/vehicles/{vehicleId} {
      allow read, write: if isSignedIn() && isOwner(userId) && isActivated(userId);
    }

    /**
     * @description Controls access to service history for a specific vehicle.
     * @allow (all) - Only an activated user can perform CRUD on their own service records.
     * @deny (all) - Unactivated users or users trying to access other's data are denied.
     */
    match /users/{userId}/clients/{clientId}/vehicles/{vehicleId}/serviceHistory/{serviceId} {
      allow read, write: if isSignedIn() && isOwner(userId) && isActivated(userId);
    }
  }
}
